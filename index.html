<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Game Launcher</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      /* --- GLOBAL STYLES --- */
      body {
        margin: 0;
        background: #000;
        color: #0f0;
        font-family: "Courier New", monospace;
        height: 100vh;
        overflow: hidden;
      }
      #loader, #main-menu, #sub-menu, #level-submenu {
        position: fixed;
        inset: 0;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }
      #loader { display: flex; }
      #log {
        width: 80%;
        max-width: 800px;
        height: 320px;
        overflow-y: auto;
        border: 1px solid #0f0;
        padding: 10px;
        margin-bottom: 20px;
        background: rgba(0, 15, 0, 0.1);
        font-size: 14px;
        line-height: 1.4;
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #0f0;
        border-top: 4px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      .menu-title {
        font-size: 2.5em;
        margin-bottom: 30px;
        text-shadow: 0 0 10px #0f0;
      }
      .menu-btn, .level-btn {
        background: transparent;
        border: 2px solid #0f0;
        color: #0f0;
        padding: 12px 24px;
        margin: 8px;
        font-size: 1.2em;
        cursor: pointer;
        width: 280px;
        transition: all 0.3s ease;
      }
      .menu-btn:hover, .level-btn:hover {
        background: #0f0;
        color: #000;
        box-shadow: 0 0 20px #0f0;
      }
      @keyframes flashRed {
        0% { color: #f00; border-color: #f00; }
        50% { color: #000; border-color: #000; background: #f00; }
        100% { color: #f00; border-color: #f00; background: transparent; }
      }
      .scp-btn { border-color: #f00; color: #f00; text-shadow: 0 0 10px #f00; animation: flashRed 1s infinite; }
      .error { color: #f55; }
      .success { color: #0f0; }
      .scp-log { color: #f00; text-shadow: 0 0 5px #f00; }

      /* --- SCP overlay --- */
      #scp-warning {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        color: #f00;
        font-family: "Courier New", monospace;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        z-index: 999;
      }
      #scp-pass {
        margin: 20px;
        padding: 10px;
        font-size: 1.2em;
        border: 2px solid #f00;
        background: #000;
        color: #f00;
        text-align: center;
      }
      #scp-warning button {
        margin: 10px;
        padding: 12px 24px;
        border: 2px solid #f00;
        background: transparent;
        color: #f00;
        cursor: pointer;
      }
      #scp-warning button:hover { background: #f00; color: #000; box-shadow: 0 0 20px #f00; }
      #scp-error { margin-top: 15px; color: #f55; min-height: 22px; }

      /* --- Cutscene overlay --- */
      .overlay {
        position: fixed;
        inset: 0;
        background: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .overlay video { width: 100%; height: 100%; object-fit: cover; }
      .overlay button {
        position: absolute;
        right: 16px;
        bottom: 16px;
        border: 1px solid #0f0;
        background: transparent;
        color: #0f0;
        padding: 8px 12px;
        cursor: pointer;
      }

      /* --- Category submenu scroll --- */
      #button-container, #level-button-container {
        max-height: 70vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
    </style>
  </head>
  <body>
    <!-- LOADER -->
    <div id="loader">
      <div class="spinner"></div>
      <div id="log"></div>
    </div>

    <!-- MAIN MENU -->
    <div id="main-menu">
      <div class="menu-title">MAIN MENU</div>
      <button class="menu-btn" onclick="showCategory('backrooms')">Backrooms Levels</button>
      <button class="menu-btn scp-btn" onclick="showCategory('scp')">SCP Levels</button>
      <button class="menu-btn" onclick="showCategory('old')">Old Game</button>
    </div>

    <!-- CATEGORY SUB MENU -->
    <div id="sub-menu">
      <div class="menu-title" id="sub-title"></div>
      <div id="button-container"></div>
      <button class="menu-btn" onclick="returnToMain()">← Back</button>
    </div>

    <!-- LEVEL SUBMENU (per-level) -->
    <div id="level-submenu">
      <div class="menu-title" id="level-title"></div>
      <div id="level-button-container"></div>
      <button class="menu-btn" onclick="returnToCategory()">← Back</button>
    </div>

    <!-- SCP WARNING -->
    <div id="scp-warning">
      <h2>⚠ SCP Containment Access Required ⚠</h2>
      <p>
        You are attempting to access a restricted SCP containment area.<br />
        Unauthorized entry may result in anomalous exposure.
      </p>
      <input id="scp-pass" type="password" placeholder="Enter containment passcode" />
      <div>
        <button id="scp-confirm">Confirm Entry</button>
        <button id="scp-cancel">Cancel</button>
      </div>
      <div id="scp-error"></div>
    </div>

    <!-- Siren -->
    <audio id="scp-siren" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto" loop></audio>

    <script>
      /* ---------------------------
       * CONFIG: Plug-and-play levels
       * ---------------------------
       * Add/remove entries here. The loader builds menus automatically.
       * Fields:
       * - filename: HTML file to launch (relative path)
       * - name: Button label
       * - category: "backrooms" | "scp" | "old"
       * - requiresPasscode: optional boolean to gate behind SCP overlay
       * Cutscene is auto-detected by checking "<basename>.mp4" next to the HTML.
       */

      const levels = [
        { filename: "Level0.html",   name: "Level 0 – Office Maze",          category: "old" },
        { filename: "Level0v2.html", name: "Level 0 – Multi file test",          category: "backrooms" },
        { filename: "Level37.html",  name: "Level 37 – Poolrooms",           category: "backrooms" },
        { filename: "SCPLevel0.html",name: "SCP Level 0",                    category: "scp", requiresPasscode: true },
        { filename: "Level1.html",   name: "Level 1 – Parking Garage",       category: "backrooms" },
        { filename: "TEMP.html",     name: "Old Backrooms Game",             category: "old" }
      ];

      /* --- STATE --- */
      const validLevels = [];          // { ...entry, hasCutscene: boolean }
      let lastCategory = null;         // remember which category we were viewing
      let selectedLevel = null;        // currently opened level in the per-level submenu

      const log = document.getElementById("log");
      const loader = document.getElementById("loader");
      const mainMenu = document.getElementById("main-menu");
      const subMenu = document.getElementById("sub-menu");
      const buttonContainer = document.getElementById("button-container");
      const subTitle = document.getElementById("sub-title");
      const levelSubmenu = document.getElementById("level-submenu");
      const levelTitle = document.getElementById("level-title");
      const levelButtonContainer = document.getElementById("level-button-container");

      let SCP_PASSCODE = String(Math.floor(100 + Math.random() * 900));

      /* --- LOGGING + BOOT --- */
      function addLog(msg, cls = "") {
        return new Promise((resolve) => {
          const line = document.createElement("div");
          line.textContent = msg;
          if (cls) line.className = cls;
          log.appendChild(line);
          log.scrollTop = log.scrollHeight;
          setTimeout(resolve, 220 + Math.random() * 260);
        });
      }

      async function fakeChecks() {
        const checks = [
          "Booting system kernel...",
          "Initializing memory modules...",
          "Calibrating rendering pipeline...",
          "Verifying asset integrity...",
          "Preparing level registry...",
          "Cross-referencing SCP containment files...",
          "Validating SCP Level entries...",
          "⚠️ Warning: anomalous entities detected..."
        ];
        for (const c of checks) {
          const cls = c.includes("SCP") || c.includes("anomalous") ? "scp-log" : "";
          await addLog(c, cls);
        }
        await addLog(`Containment override token issued: ${SCP_PASSCODE}`, "scp-log");
      }

      /* --- FILE PROBE HELPERS --- */
      function basename(path) {
        const i = path.lastIndexOf(".");
        return i >= 0 ? path.slice(0, i) : path;
      }

      function probeExists(url) {
        // Use HEAD fetch; falls back gracefully if server disallows HEAD
        return fetch(url, { method: "HEAD" })
          .then(res => res.ok)
          .catch(() => false);
      }

      async function checkEntry(entry) {
        const htmlOk = await probeExists(entry.filename);
        const mp4Name = basename(entry.filename) + ".mp4";
        const mp4Ok = await probeExists(mp4Name);

        await addLog(`→ Scanning ${entry.name} (${entry.filename})...`);

        if (htmlOk) {
          const cls = entry.category === "scp" ? "scp-log" : "success";
          const tag = entry.category === "scp" ? "anomaly verified" : "verified";
          await addLog(`[✓] ${entry.name} ${tag}`, cls);

          validLevels.push({
            ...entry,
            hasCutscene: mp4Ok,
            cutsceneSrc: mp4Ok ? mp4Name : null
          });
          if (mp4Ok) {
            await addLog(`Cutscene detected: ${mp4Name}`, "success");
          } else {
            await addLog(`No cutscene found for ${entry.name}`, "error");
          }
        } else {
          await addLog(`[✖] ${entry.name} missing or failed to load`, "error");
        }
      }

      async function bootSequence() {
        await fakeChecks();

        // De-duplicate and sanitize
        const seen = new Set();
        const sanitized = levels.filter(l => {
          if (!l || !l.filename || !l.name || !l.category) return false;
          if (seen.has(l.filename)) return false;
          seen.add(l.filename);
          return true;
        });

        for (const entry of sanitized) {
          await checkEntry(entry);
        }

        await addLog("Scan complete.");
        loader.style.display = "none";
        mainMenu.style.display = "flex";
      }

      /* --- CATEGORY MENU --- */
      function showCategory(category) {
        lastCategory = category;
        mainMenu.style.display = "none";
        levelSubmenu.style.display = "none";
        subMenu.style.display = "flex";
        buttonContainer.innerHTML = "";

        subTitle.textContent =
          category === "backrooms" ? "Backrooms Levels" :
          category === "scp" ? "SCP Levels" :
          "Old Game";

        const list = validLevels
          .filter(l => l.category === category)
          .slice()
          .sort((a, b) => a.name.localeCompare(b.name));

        if (!list.length) {
          const info = document.createElement("div");
          info.textContent = "No levels available in this category.";
          info.className = "error";
          buttonContainer.appendChild(info);
          return;
        }

        for (const level of list) {
          const btn = document.createElement("button");
          btn.className = level.category === "scp" ? "level-btn scp-btn" : "level-btn";
          btn.textContent = level.name;
          btn.onclick = () => openLevelSubmenu(level);
          buttonContainer.appendChild(btn);
        }
      }

      function returnToMain() {
        subMenu.style.display = "none";
        levelSubmenu.style.display = "none";
        mainMenu.style.display = "flex";
      }

      function returnToCategory() {
        levelSubmenu.style.display = "none";
        subMenu.style.display = "flex";
      }

      /* --- PER-LEVEL SUBMENU --- */
      function openLevelSubmenu(level) {
        selectedLevel = level;

        // If SCP-gated, require pass first, then show submenu
        if (level.category === "scp" && level.requiresPasscode) {
          showSCPWarning(() => {
            renderLevelSubmenu(level);
          });
        } else {
          renderLevelSubmenu(level);
        }
      }

      function renderLevelSubmenu(level) {
        subMenu.style.display = "none";
        levelSubmenu.style.display = "flex";
        levelTitle.textContent = level.name;
        levelButtonContainer.innerHTML = "";

        // If a cutscene exists, show both options; otherwise only Play Level
        if (level.hasCutscene && level.cutsceneSrc) {
          const playCutsceneBtn = document.createElement("button");
          playCutsceneBtn.className = "level-btn";
          playCutsceneBtn.textContent = "Play Cutscene";
          playCutsceneBtn.onclick = () => playCutsceneThenLevel(level.cutsceneSrc, level.filename);
          levelButtonContainer.appendChild(playCutsceneBtn);

          const playLevelBtn = document.createElement("button");
          playLevelBtn.className = "level-btn";
          playLevelBtn.textContent = "Play Level";
          playLevelBtn.onclick = () => launchLevel(level.filename);
          levelButtonContainer.appendChild(playLevelBtn);
        } else {
          const playLevelBtn = document.createElement("button");
          playLevelBtn.className = "level-btn";
          playLevelBtn.textContent = "Play Level";
          playLevelBtn.onclick = () => launchLevel(level.filename);
          levelButtonContainer.appendChild(playLevelBtn);
        }
      }

      /* --- LAUNCH FLOW (Cutscene + Level iframe) --- */
      function playCutsceneThenLevel(videoSrc, levelFile) {
        const overlay = document.createElement("div");
        overlay.className = "overlay";

        const vid = document.createElement("video");
        vid.src = videoSrc;
        vid.autoplay = true;
        vid.muted = true;
        vid.playsInline = true;

        const skip = document.createElement("button");
        skip.textContent = "Skip";

        overlay.appendChild(vid);
        overlay.appendChild(skip);
        document.body.appendChild(overlay);

        const tryPlay = () => vid.play().catch(() => {});
        tryPlay();
        document.body.addEventListener("click", () => {
          if (vid.paused) tryPlay();
        }, { once: true });

        const complete = () => { cleanupOverlay(); launchLevel(levelFile); };
        vid.addEventListener("ended", complete);
        skip.addEventListener("click", complete);
        vid.addEventListener("error", complete);

        function cleanupOverlay() {
          try { overlay.remove(); } catch {}
        }
      }

      function launchLevel(file) {
        const iframe = document.createElement("iframe");
        iframe.src = file;
        Object.assign(iframe.style, {
          position: "fixed",
          top: "0",
          left: "0",
          width: "100%",
          height: "100%",
          border: "none",
          zIndex: "1000",
          background: "#000"
        });
        document.body.appendChild(iframe);
        levelSubmenu.style.display = "none";

        const escHandler = (e) => {
          if (e.key === "Escape") {
            try { iframe.remove(); } catch {}
            // Return to the level submenu for the same level (skip-before-play UX persists)
            renderLevelSubmenu(selectedLevel);
            document.removeEventListener("keydown", escHandler);
          }
        };
        document.addEventListener("keydown", escHandler);
      }

      /* --- SCP overlay logic --- */
      function showSCPWarning(onSuccess) {
        const warning = document.getElementById("scp-warning");
        const confirmBtn = document.getElementById("scp-confirm");
        const cancelBtn = document.getElementById("scp-cancel");
        const passInput = document.getElementById("scp-pass");
        const errorMsg = document.getElementById("scp-error");
        const siren = document.getElementById("scp-siren");

        warning.style.display = "flex";
        errorMsg.textContent = "";
        passInput.value = "";

        try { siren.currentTime = 0; siren.play().catch(() => {}); } catch (e) {}

        confirmBtn.onclick = () => {
          if (passInput.value === SCP_PASSCODE) {
            try { siren.pause(); } catch (e) {}
            warning.style.display = "none";
            onSuccess?.();
          } else {
            errorMsg.textContent = "Access denied. Invalid containment code.";
          }
        };

        cancelBtn.onclick = () => {
          try { siren.pause(); } catch (e) {}
          warning.style.display = "none";
          // If cancelling, return to the category view
          if (lastCategory) showCategory(lastCategory);
          else returnToMain();
        };
      }

      /* --- BOOT --- */
      (async function start() {
        await bootSequence();
      })();
    </script>
  </body>
</html>
