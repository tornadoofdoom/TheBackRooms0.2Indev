<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Level 1 â€“ Parking Area</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        background: #000;
        overflow: hidden;
      }
      canvas {
        display: block;
      }
      #hint {
        position: fixed;
        top: 8px;
        left: 8px;
        color: #9f9;
        font-family: monospace;
        z-index: 10;
      }
      #debugPanel {
        position: fixed;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.7);
        color: #8bf;
        border: 1px solid #8bf;
        padding: 8px;
        display: none;
        font-family: monospace;
        min-width: 280px;
      }
      #debugPanel .row {
        display: flex;
        justify-content: space-between;
      }
      #debugPanel .label {
        color: #b7d9ff;
      }
      #debugPanel .value {
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div id="hint">
      Click canvas to lock pointer. WASD move | Shift sprint | ` or F9 debug
    </div>
    <div id="debugPanel"></div>

    <script type="module">
      import {
        initRendererSceneCamera,
        addFogAndLights,
      } from "./Level1/render.js";
      import {
        initPlayerControls,
        updatePlayer,
        getPlayerState,
        getPlayerObject,
      } from "./Level1/player.js";
      import { ChunkManager } from "./Level1/chunks.js";
      import { initDebug, toggleDebug, updateDebug } from "./Level1/debug.js";
      import {
        initEntities,
        spawnSmiler,
        updateSmilers,
        getSmilerStats,
      } from "./Level1/entities.js";
      import { buildParkingArea } from "./Level1/parkingArea.js";

      // Scene setup
      const { renderer, scene, camera } = await initRendererSceneCamera({
        bg: 0x0b0b0b,
      });
      addFogAndLights(scene);

      // Player setup
      initPlayerControls(camera, renderer.domElement);
      scene.add(getPlayerObject());

      // Systems
      const chunks = new ChunkManager(scene, { chunkSize: 12, radius: 3 });
      initDebug();
      initEntities(scene);

      // Build Parking Area
      buildParkingArea(scene);

      // Spawn an inactive Smiler
      spawnSmiler({ x: 5, y: 0, z: 5 }, { noAI: true });

      // Loop
      let last = performance.now();
      function loop(now = performance.now()) {
        requestAnimationFrame(loop);
        const dt = Math.min((now - last) / 1000, 0.05);
        last = now;

        updatePlayer(dt);
        const state = getPlayerState();

        const zone = chunks.getZoneForPosition(state.position);
        const floor = chunks.getFloorForPosition(state.position);

        chunks.update(state.position);
        updateSmilers(state.position, dt, zone);

        const smilerStats = getSmilerStats();
        updateDebug({
          fps: (1 / dt) | 0,
          pos: state.position,
          floor,
          zone,
          chunk: chunks.getChunkIndex(state.position),
          smilersTotal: smilerStats.total,
          smilersChasing: smilerStats.chasing,
          smilersIdle: smilerStats.idle,
        });

        renderer.render(scene, camera);
      }
      loop();

      // Keybindings
      window.addEventListener("keydown", (e) => {
        if (e.key === "`" || e.key.toLowerCase() === "f9") toggleDebug();
      });

      // Resize
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
